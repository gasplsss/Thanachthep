<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô ‚Ä¢ LOOK UP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --line:#e7e9ef; --text:#0f172a; --muted:#64748b;
      --accent:#2563eb; --danger:#ef4444; --success:#16a34a; --warn:#f59e0b;
      --radius:14px; --radius-sm:10px; --shadow:0 2px 8px rgba(15,23,42,.06), 0 12px 24px rgba(15,23,42,.06);
      --focus:0 0 0 3px rgba(37,99,235,.25);
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b1020; --card:#0f1528; --line:#20263a; --text:#e5e7eb; --muted:#94a3b8; --shadow:0 2px 12px rgba(0,0,0,.5), 0 20px 40px rgba(0,0,0,.35); }
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;display:flex;gap:10px;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line);backdrop-filter:blur(8px);background:color-mix(in oklab, var(--card) 92%, transparent)}
    header .sp{flex:1}
    a.btn,button.btn{appearance:none;border:0;border-radius:var(--radius-sm);padding:10px 14px;font-weight:800;cursor:pointer;text-decoration:none;display:inline-block;transition:.18s ease;box-shadow:var(--shadow)}
    .btn{background:#e5e7eb;color:#111827}
    .btn.primary{background:var(--accent);color:#fff}
    .btn:focus-visible{outline:none;box-shadow:var(--focus), var(--shadow)}

    main{max-width:560px;margin:24px auto;padding:0 16px 80px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}

    label{display:block;margin:10px 0 6px;font-weight:700;color:var(--muted)}
    .field{position:relative}
    input{width:100%;padding:12px 40px 12px 12px;border:1px solid var(--line);border-radius:12px;background:#fff}
    input:focus{outline:none;box-shadow:var(--focus)}
    .toggle{position:absolute;right:8px;top:50%;transform:translateY(-50%);border:1px solid var(--line);background:var(--card);border-radius:999px;width:34px;height:34px;display:grid;place-items:center;cursor:pointer}

    .actions{display:flex;gap:10px;align-items:center;margin-top:14px}

    .meter{height:10px;border-radius:999px;background:#e5e7eb;overflow:hidden;border:1px solid var(--line)}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#ef4444,#f59e0b,#16a34a);transition:width .2s ease}
    .muted{color:var(--muted);font-size:12px}

    .toast-wrap{position:fixed;right:16px;bottom:16px;display:grid;gap:10px;z-index:50}
    .toast{background:var(--card);border:1px solid var(--line);box-shadow:var(--shadow);padding:12px 14px;border-radius:12px;font-weight:700}
  </style>
</head>
<body>
  <header>
    <b>üîê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</b>
    <div class="sp"></div>
    <a class="btn" href="/user/user.html">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö</a>
  </header>

  <main>
    <div class="card">
      <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
      <div class="field">
        <input id="old" type="password" autocomplete="current-password" />
        <button class="toggle" onclick="toggleVis('old')" aria-label="‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™">üëÅÔ∏è</button>
      </div>

      <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
      <div class="field">
        <input id="nw" type="password" autocomplete="new-password" oninput="strength()" />
        <button class="toggle" onclick="toggleVis('nw')" aria-label="‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™">üëÅÔ∏è</button>
      </div>
      <div class="meter" aria-hidden="true"><div id="bar" class="bar"></div></div>
      <div id="tip" class="muted" style="margin-top:6px">‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß ‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ú‡∏™‡∏°</div>

      <label>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
      <div class="field">
        <input id="cf" type="password" autocomplete="new-password" />
        <button class="toggle" onclick="toggleVis('cf')" aria-label="‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™">üëÅÔ∏è</button>
      </div>

      <div class="actions">
        <button id="saveBtn" class="btn primary" onclick="save()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </main>

  <div id="toasts" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

<script>
  const $ = s => document.querySelector(s);
  const toast = (m)=>{ const w=$('#toasts'); const t=document.createElement('div'); t.className='toast'; t.textContent=m; w.appendChild(t); setTimeout(()=>{t.style.opacity='0'; setTimeout(()=>t.remove(),260)}, 2200); };

  // --- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login ---
  (async function ensureAuth(){
    try{
      const r = await fetch('/api/user/profile', { credentials:'include', cache:'no-store' });
      if(r.status === 401){ alert('‡∏´‡∏°‡∏î‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'); location.href='/login.html'; }
    }catch(e){ /* ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÑ‡∏ß‡πâ */ }
  })();

  // --- toggle password visibility ---
  const toggleVis = (id)=>{ const i=$('#'+id); i.type = i.type==='password' ? 'text' : 'password'; };

  // --- strength meter ---
  const score = (pwd)=>{
    let s=0;
    if(pwd.length>=8) s++;
    if(/[A-Z]/.test(pwd)) s++;
    if(/[a-z]/.test(pwd)) s++;
    if(/[0-9]/.test(pwd)) s++;
    if(/[^A-Za-z0-9]/.test(pwd)) s++;
    if(pwd.length>=12) s++;
    return Math.min(s,5); // 0..5
  };
  function strength(){
    const v = $('#nw').value || '';
    const s = score(v);
    const pct = [0,20,40,60,80,100][s];
    $('#bar').style.width = pct+'%';
    $('#tip').textContent = s>=4 ? '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏î‡∏µ' : '‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß ‡∏ú‡∏™‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç/‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏à‡∏∞‡∏î‡∏µ‡∏¢‡∏¥‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô';
  }

  // --- submit on Enter ---
  document.addEventListener('keydown', e=>{
    if(e.key==='Enter') save();
  });

  // --- save password (‡∏™‡πà‡∏á‡∏Ñ‡∏∏‡∏Å‡∏Å‡∏µ‡πâ‡πÑ‡∏õ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠) ---
  async function save(){
    const btn = $('#saveBtn');
    const old = $('#old').value.trim();
    const nw  = $('#nw').value.trim();
    const cf  = $('#cf').value.trim();
    if(!old || !nw || !cf) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
    if(nw!==cf) return alert('‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
    if(score(nw) < 3) return alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏¢‡∏±‡∏á‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ');

    btn.disabled = true; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶';
    try{
      const r = await fetch('/api/user/change-password', {
        method:'PUT',
        headers:{ 'Content-Type':'application/json' },
        credentials:'include',           // << ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡πà‡∏á‡∏Ñ‡∏∏‡∏Å‡∏Å‡∏µ‡πâ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
        cache:'no-store',
        body: JSON.stringify({ old_password: old, new_password: nw })
      });
      const d = await r.json().catch(()=>({}));

      if(r.status === 200){
        toast('‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        setTimeout(()=>location.href='/user/user.html', 700);
      }else if(r.status === 401){
        alert('Unauthorized\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'); location.href='/login.html';
      }else{
        alert(d.message || '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }
    }catch(e){
      alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }finally{
      btn.disabled = false; btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
    }
  }
</script>
</body>
</html>
